\newcommand{\ruleName}[2]{\customlabel{#1}{\ensuremath{\mathrm{run}_{#2}}}}
\newcommand{\RightLabelM}[1]{\RightLabel{\scriptsize #1}}

\newcommand{\ruleFail}{\ruleName{rule:backtrack}{\circlearrowright }}
\newcommand{\ruleAbort}{\ruleName{rule:abort}{\bot}}
\newcommand{\ruleCall}{\ruleName{rule:call}{@}}
\newcommand{\ruleCallF}{\ruleName{rule:callbacktrack}{\circlearrowright}}
\newcommand{\ruleCallFH}{\ruleName{rule:callabort}{\bot}}
\newcommand{\ruleCallB}{\ruleName{rule:call1}{@'}}
\newcommand{\ruleBeta}{\ruleName{rule:beta}{\sigma}}
\newcommand{\ruleBang}{\ruleName{rule:cut}{!}}
\newcommand{\ruleStop}{\ruleName{rule:stop}{\top}}
\newcommand{\ruleUnif}{\ruleName{rule:unif}{=}}
\newcommand{\ruleImpl}{\ruleName{rule:impl}{\Rightarrow}}
\newcommand{\rulePi}{\ruleName{rule:pi}{\forall}}
\newcommand{\ruleMatch}{\ruleName{rule:match}{m}}
\newcommand{\rulePiImpl}{\ruleName{rule:piimpl}{{\piimpl}}}

\newcommand{\ruleStopM}[1]{
  \begin{myRule}{#1}
    % STOP
    \AxiomC{}
    \RightLabelM{\ruleStop}
    \UnaryInfC{\runCmd{\EmptyList}{\alts}{\subst}{\alts}{\subst}}
  \end{myRule}
}

\newcommand{\ruleUnifM}[1]{
  \begin{myRule}{#1}
    % UNIF
    \AxiomC{\unifyCmd{x}{y}{\subst}{\subst[']}}
    \AxiomC{\runCmdR{\gl}{\alts}{\subst[']}}
    \RightLabelM{\ruleUnif}
    \BinaryInfC{\runCmdR{\ConsHdNP{\goalCmd{\_}{x = y}{\_}}\ConsTlNP{\gl}}{\alts}{\subst}}
  \end{myRule}
}

\newcommand{\ruleMatchM}[1]{
  \begin{myRule}{#1}
    % MATCH
    \AxiomC{\matchCmd{x}{y}{\subst}{\subst[']}}
    \AxiomC{\runCmd{\gl}{\alts}{\subst[']}{\alts[']}{\subst['']}}
    \RightLabelM{\ruleMatch}
    \BinaryInfC{\runCmd{\ConsHdNP{\goalCmd{\_}{(x =_m y)}{\_}}\ConsTlNP{\gl}}{\alts}{\subst}{\alts[']}{\subst['']}}
  \end{myRule}
}

\newcommand{\ruleFailM}[1]{
  \begin{myRule}{#1}
    % FAIL
    \AxiomC{\unifyCmd{x}{y}{\subst}{\bot}}
    \AxiomC{\runCmdQR{\alts}{al}}
    \RightLabelM{\ruleFail}
    \BinaryInfC{\runCmdR{\ConsHdNP{\goalCmd{\_}{x = y}{\_}}\ConsTlNP{\_}}{\ConsHd{\alts}\ConsTl{al}}{\subst}}
  \end{myRule}%
}

\newcommand{\ruleAbortM}[1]{
  \begin{myRule}{#1}
    % FAIL
    \AxiomC{\unifyCmd{x}{y}{\subst}{\bot}}
    \RightLabelM{\ruleAbort}
    \UnaryInfC{\runCmdF{\ConsHdNP{\goalCmd{\_}{x = y}{\_}}\ConsTlNP{\_}}{\EmptyList}{\subst}}
  \end{myRule}%
}

\newcommand{\ruleBangM}[1]{
  \begin{myRule}{#1}
    % CUT
    \AxiomC{\runCmdR{\gl}{\alts}{\subst}}
    \RightLabelM{\ruleBang}
    \UnaryInfC{\runCmdR{\ConsHdNP{\goalCmd{\_}{\cut}{\alts}}\ConsTlNP{\gl}}{\_}{\subst}}
  \end{myRule}
}

\newcommand{\ruleCallM}[1]{
  \begin{myRule}{#1}
    % CALL
    \AxiomC{$\mathcal{F}(\prog, \pred\ \vec{t}, \subst, \alts) = \ConsHdNP{\alts[']}\ConsTlNP{al'}$}
    \AxiomC{\runCmdQR{\alts[']}{(al'\ @\ al)}}
    \RightLabelM{\ruleCall}
    \BinaryInfC{\runCmdR{\ConsHdNP{\goalCmd{\prog}{\callCmd{\pred}{\vec{t}}}{\_}}\ConsTlNP{\gl}}{al}{\subst}}
  \end{myRule}
}
\newcommand{\ruleCallMF}[1]{
  \begin{myRule}{#1}
    % CALL
    \AxiomC{$\mathcal{F}(\prog, \pred\ \vec{t}, \subst, \alts) = \EmptyList$}
    \AxiomC{\runCmdQR{a}{al}}
    \RightLabelM{\ruleCallF}
    \BinaryInfC{\runCmdR{\ConsHdNP{\goalCmd{\prog}{\callCmd{\pred}{\vec{t}}}{\_}}\ConsTlNP{\gl}}{(a :: al)}{\subst}}
  \end{myRule}
}
\newcommand{\ruleCallMFH}[1]{
  \begin{myRule}{#1}
    % CALL
    \AxiomC{$\mathcal{F}(\prog, \pred\ \vec{t}, \subst, \alts) = \EmptyList$}
    \RightLabelM{\ruleCallFH}
    \UnaryInfC{\runCmdF{\ConsHdNP{\goalCmd{\prog}{\callCmd{\pred}{\vec{t}}}{\_}}\ConsTlNP{\gl}}{\EmptyList}{\subst}}
  \end{myRule}
}

\newcommand{\ruleCallBeta}[1]{
  \begin{myRule}{#1}
    \AxiomC{$\subst (X\ \vec{t}) =_{\beta\eta} \pred\ \vec{u}$}
    \AxiomC{\runCmdR{\ConsHdNP{\goalCmd{\prog}{\pred\ \vec{u}}{a}}\ConsTlNP{\gl}}{\alts[']}{\subst}}
    \RightLabelM{\ruleBeta}
    \BinaryInfC{\runCmdR{\ConsHdNP{\goalCmd{\prog}{(X\ \vec{t})}{a}}\ConsTlNP{\gl}}{\alts[']}{\subst}}
  \end{myRule}
}


\newcommand{\ruleCallBM}[1]{
  \begin{myRule}{#1}
    % CALLB
    \AxiomC{$(\subst h)\ \vec{t} =_\beta \pred\ \vec{u}$}
    \AxiomC{$\mathcal{F}(\prog, \pred\ \vec{u}, \subst, \alts) = \ConsHdNP{g}\ConsTlNP{new\_alt}$}
    \AxiomC{\runCmdR{(g\ @\ \gl)}{(new\_alt\ @\ \alts)}{\subst}}
    \RightLabelM{\ruleCallB}
    \TrinaryInfC{\runCmdR{\ConsHdNP{\goalCmd{\prog}{(h\ \vec{t})}{\_}}\ConsTlNP{\gl}}{\alts}{\subst}}
  \end{myRule}
}

\newcommand{\env}{\ensuremath{\mathcal{E}}}

% \newcommand{\ruleImplM}[1]{
%   \begin{myRule}{#1}
%     % IMPL
%     \AxiomC{\runCmd{\ConsHdNP{(\goalCmd{(H + \ctx)}{B}{\alts})}\ConsTlNP{\gl}}{\alts[']}{\subst}{\alts['']}{\subst[']}}
%     \RightLabelM{\ruleImpl}
%     \UnaryInfC{\runCmd{\ConsHdNP{\goalCmd{\ctx}{(\implCmd{H}{B})}{\alts}}\ConsTlNP{\gl}}{\alts[']}{\subst}{\alts['']}{\subst[']}}
%   \end{myRule}
% }

% \newcommand{\rulePiM}[1]{
%   \begin{myRule}{#1}
%     % PI
%     \AxiomC{\runCmd{\ConsHdNP{\goalCmd{(x \uplus \ctx)}{B}{\alts}}\ConsTlNP{\gl}}{\alts[']}{\subst}{\alts['']}{\subst[']}}
%     \RightLabelM{\rulePi}
%     \UnaryInfC{\runCmd{\ConsHdNP{\goalCmd{\ctx}{(\piCmd{x}{B})}{\alts}}\ConsTlNP{\gl}}{\alts[']}{\subst}{\alts['']}{\subst[']}}
%   \end{myRule}
% }

\newcommand{\rulePiImplM}[1]{
  \begin{myRule}{#1}
    % IMPL
    \AxiomC{$y \# \prog$}
    \AxiomC{\runCmdR{\ConsHdNP{\goalCmd{(y, h[y/x]) + \prog}{g[y/x]}{\alts}}\ConsTlNP{\gl}}{\alts[']}{\subst}}
    \RightLabelM{\rulePiImpl}
    \BinaryInfC{\runCmdR{\ConsHdNP{\goalCmd{\prog}{(\piCmd{x}{\implCmd{h}{g}})}{\alts}}\ConsTlNP{\gl}}{\alts[']}{\subst}}
  \end{myRule}
}

% \newcommand{\ruleLam}{\ruleName{\lambda}}
% \newcommand{\ruleLamM}[1]{
%   \begin{myRule}{#1}
%     % PI
%     \AxiomC{\runCmd{\ConsHdNP{\goalCmd{\ctx}{(B[x\backslash T])}{\alts}}\ConsTlNP{\gl}}{\alts[']}{\subst}{\alts['']}{\subst[']}}
%     \RightLabelM{\ruleLam}
%     \UnaryInfC{\runCmd{\ConsHdNP{\goalCmd{\ctx}{((\lambda x. B) T)}{\alts}}\ConsTlNP{\gl}}{\alts[']}{\subst}{\alts['']}{\subst[']}}
%   \end{myRule}
% }
