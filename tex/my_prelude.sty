\usepackage[newfloat,outputdir=.aux]{minted}
\usepackage{bussproofs}
\usepackage{xspace}
\usepackage{mathtools}
\usepackage{multicol}
\usepackage{cleveref}
\usepackage{todonotes}

% \usepackage{amssymb}% http://ctan.org/pkg/amssymb
\usepackage{pifont}% http://ctan.org/pkg/pifont
\newcommand{\cmark}{\ding{51}}%
\newcommand{\xmark}{\ding{55}}%

\newcommand{\subst}[1][]{\ensuremath{\sigma#1}\xspace}
\newcommand{\alt}[1][]{\ensuremath{\mathcal{A}#1}\xspace}
\newcommand{\g}[1][]{\ensuremath{\mathcal{G}#1}\xspace}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Languages: start

\newcommand{\lang}[1]{\texttt{#1}\xspace}

\newcommand{\prolog}{\lang{prolog}}
\newcommand{\mixtus}{\lang{mixtus}}
\newcommand{\mercury}{\lang{mercury}}
\newcommand{\twelf}{\lang{twelf}}
\newcommand{\elpi}{\lang{elpi}}
\newcommand{\coq}{\lang{coq}}

\newcommand{\Mercury}{\lang{Mercury}}
\newcommand{\Elpi}{\lang{Elpi}}
\newcommand{\Coq}{\lang{Coq}}
\newcommand{\lamprolog}{\lang{$\lambda$prolog}}

% Languages: end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newenvironment{elpicode}{%
  \vspace{0.2em}%
  \VerbatimEnvironment
  \begin{minted}[fontsize=\small,autogobble,escapeinside=~~,mathescape=true,frame=leftline,framerule=0pt,framesep=1em]{'elpi.py:ElpiLexer -x'}%
}{%
  \end{minted}%
  \vspace{0.2em}%
}
\newcommand{\elpiIn}[1]{\mintinline[fontsize=\small,escapeinside=~~]{'elpi.py:ElpiLexer -x'}{#1}}

\newenvironment{coqcode}{%
  \vspace{0.2em}%
  \VerbatimEnvironment
  \begin{minted}[fontsize=\small,autogobble,escapeinside=~~,mathescape=true,frame=leftline,framerule=0pt,framesep=1em,texcomments]{coq}%
}{%
  \end{minted}%
  \vspace{0.2em}%
}


% goal{program}{goal}{alternatives}
\newcommand{\run}{\texttt{run}}
\newcommand{\call}{\texttt{Call}}
\newcommand{\cut}{\texttt{Cut}}
\newcommand{\goal}{\texttt{Goal}}

% runCmd{goal[]}{alts[]}{subst}{alts_res}{subst_res}
\newcommand{\runCmd}[5]{\ensuremath{\run\ #1\ #2\ #3 \to (#4, #5)}}
\newcommand{\callCmd}[3]{\ensuremath{(\call\ #1\ #2\ #3)}\xspace}
\newcommand{\goalCmd}[3]{\ensuremath{\goal\ #1\ #2\ #3}\xspace}

\newcommand{\Cons}[1]{\ensuremath{#1::}}
\newcommand{\ConsHd}[1]{\ensuremath{(#1::}\xspace}
\newcommand{\ConsTl}[1]{\ensuremath{#1)}\xspace}
\newcommand{\EmptyList}{\ensuremath{[\ ]}}

\newcommand{\EmptySubst}{\ensuremath{\varepsilon}}

\newcommand{\prog}{\ensuremath{\mathcal{P}}\xspace}
\newcommand{\evdash}{\ensuremath{\colondash}\xspace}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Derivation system: start
\newenvironment{myRule}[1]{%
   \begin{minipage}{#1\textwidth}
   \centering
   \begin{prooftree}%
  } % Here will be put the body
  {
    \end{prooftree}
    \end{minipage}
  }

\newcommand{\ruleName}[1]{\ensuremath{r_{#1}}\xspace}
\newcommand{\RightLabelM}[1]{\RightLabel{\scriptsize #1}}

\newcommand{\ruleFail}{\ruleName{\bot}}
\newcommand{\ruleCall}{\ruleName{c}}
\newcommand{\ruleBang}{\ruleName{!}}
\newcommand{\ruleStop}{\ruleName{\EmptyList}}
\newcommand{\ruleUnif}{\ruleName{=}}

\newcommand{\ruleStopM}[1]{
  \begin{myRule}{#1}
    % STOP
    \AxiomC{}
    \RightLabelM{\ruleStop}
    \UnaryInfC{\runCmd{\EmptyList}{a}{s}{a}{s}}
  \end{myRule}
}

\newcommand{\ruleUnifM}[1]{
  \begin{myRule}{#1}
    % UNIF
    \AxiomC{$\text{unify}\ x\ y\ s\ s'$}
    \AxiomC{\runCmd{gs}{a}{s'}{a'}{s''}}
    \RightLabelM{\ruleUnif}
    \BinaryInfC{\runCmd{\ConsHd{\goalCmd{\_}{x = y}{\_}}\ConsTl{gs}}{a}{s}{a'}{s''}}
  \end{myRule}
}

\newcommand{\ruleFailM}[1]{
  \begin{myRule}{#1}
    % FAIL
    \AxiomC{\runCmd{x}{xs}{s}{a'}{s'}}
    \RightLabelM{\ruleFail}
    \UnaryInfC{\runCmd{\_}{\ConsHd{s,x}\ConsTl{xs}}{\_}{a'}{s'}}
  \end{myRule}%
}

\newcommand{\ruleBangM}[1]{
  \begin{myRule}{#1}
    % CUT
    \AxiomC{\runCmd{gl}{ca}{s}{a}{s'}}
    \RightLabelM{\ruleBang}
    \UnaryInfC{\runCmd{\ConsHd{\goalCmd{\_}{!}{ca}}\ConsTl{gl}}{\_}{s}{a}{s'}}
  \end{myRule}
}

\newcommand{\ruleCallM}[1]{
  \begin{myRule}{#1}
    % CALL
    % \AxiomC{\prog p = \ConsHd{(p\ i'\ o' \evdash b)}\ConsTl{bs}}
    % \AxiomC{$\mathcal{U} \gets {[i = i', o = o']}$}
    % \AxiomC{\runCmd{(({\mathcal{U}\ @\ b})_a\ @\ gl)}{(bs_a\ @\ a)}{s}{a'}{s'}}
    % \RightLabelM{\ruleCall}
    % \TrinaryInfC{\runCmd{\ConsHd{(\prog, \call{p}{i}{o}, \_)}\ConsTl{gl}}{a}{s}{a'}{s'}}
    % 
    \AxiomC{$\mathcal{F}(\prog p, i, o, s, a) = \ConsHd{(\_,g)}\ConsTl{new\_alt}$}
    \AxiomC{\runCmd{(g\ @\ gl)}{(new\_alt\ @\ a)}{s}{a'}{s'}}
    \RightLabelM{\ruleCall}
    \BinaryInfC{\runCmd{\ConsHd{\goalCmd{\prog}{\callCmd{p}{i}{o}}{\_}}\ConsTl{gl}}{a}{s}{a'}{s'}}
  \end{myRule}
}

% Derivation system: end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
