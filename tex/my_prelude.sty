\usepackage[newfloat,outputdir=.aux]{minted}
\usepackage{bussproofs}
\usepackage{xspace}
\usepackage{mathtools}
\usepackage{multicol}
\usepackage{todonotes}
\usepackage{blindtext}
\usepackage{hyperref}
\usepackage{cleveref}
\usepackage{mdframed}  % For creating a bordered box
\usepackage{amsmath}
\usepackage{amssymb}
% \usepackage{amsthm}
\usepackage{simplebnf}

\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{definition}{Definition}
\newtheorem{corollary}{Corollary}

% \expandafter\def\expandafter\normalsize\expandafter{%
% \normalsize%
% \setlength{\belowdisplayskip}{3pt}%
% \setlength{\abovedisplayskip}{3pt}%
% \setlength{\abovedisplayshortskip}{3pt}%
% \setlength{\belowdisplayshortskip}{3pt}%
% }

\makeatletter
\newcommand{\customlabel}[2]{%
  \protected@write \@auxout {}{\string \newlabel {#1}{{\ensuremath{#2}}{\thepage}{#2}{#1}{}} }%
  \hypertarget{#1}{\ensuremath{#2}}
}
\makeatother

% \usepackage{amssymb}% http://ctan.org/pkg/amssymb
\usepackage{pifont}% http://ctan.org/pkg/pifont
\newcommand{\cmark}{\ding{51}}%
\newcommand{\xmark}{\ding{55}}%

\newcommand{\subst}[1][]{\ensuremath{\sigma#1}\xspace}
\newcommand{\alt}[1][]{\ensuremath{\mathcal{A}#1}\xspace}
\newcommand{\g}[1][]{\ensuremath{\mathcal{G}#1}\xspace}
\newcommand{\clause}[1][]{\ensuremath{\mathcal{C}#1}\xspace}
\newcommand{\pred}[1][]{\texttt{p#1}\xspace}

\newenvironment{boxedproof}
{\begin{mdframed}\begin{proof}}
{\end{proof}\end{mdframed}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Languages: start

\newcommand{\txt}[1]{\texttt{#1}}
\newcommand{\lang}[1]{\texttt{#1}\xspace}

\newcommand{\prolog}{\lang{prolog}}
\newcommand{\mixtus}{\lang{mixtus}}
\newcommand{\mercury}{\lang{mercury}}
\newcommand{\twelf}{\lang{twelf}}
\newcommand{\elpi}{\lang{elpi}}
\newcommand{\coq}{\lang{coq}}

\newcommand{\Mercury}{\lang{Mercury}}
\newcommand{\Elpi}{\lang{Elpi}}
\newcommand{\Coq}{\lang{Coq}}
\newcommand{\lamprolog}{\lang{$\lambda$prolog}}
\newcommand{\pf}{\ensuremath{L_\lambda}}

% Languages: end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newenvironment{myminted}[2][~~]{
  \vspace{0.2em}%
  \VerbatimEnvironment
  \begin{minted}[fontsize=\small,autogobble,escapeinside=#1,mathescape=true,frame=leftline,framerule=0pt,framesep=1em]{#2}%
}{
  \end{minted}%
  \vspace{0.2em}%
}

\newenvironment{elpicode}{\VerbatimEnvironment\begin{myminted}{'elpi.py:ElpiLexer -x'}}{\end{myminted}}
\newenvironment{coqcode}{\VerbatimEnvironment\begin{myminted}{coq}}{\end{myminted}}

\newcommand{\elpiIn}[1]{\mintinline[fontsize=\small,escapeinside=~~]{'elpi.py:ElpiLexer -x'}{#1}}
\newcommand{\modeAlone}[1]{\elpiIn{~\PYG{k+kMode}{#1:}~}}
\newcommand{\uvar}{\elpiIn{uvar}\xspace}

\newcommand{\coqIn}[1]{\mintinline[fontsize=\small,escapeinside=~~]{coq}{#1}}
\newcommand{\mlIn}[1]{\mintinline[fontsize=\small,escapeinside=~~]{ocaml}{#1}}


% goal{program}{goal}{alternatives}
\newcommand{\run}{\texttt{run}}
\newcommand{\call}{\texttt{Call}}
\newcommand{\cut}{\texttt{Cut}}
\newcommand{\goal}{\texttt{Goal}}
\newcommand{\unify}{\texttt{unify}\xspace}
\newcommand{\match}{\texttt{match}\xspace}
\newcommand{\impl}{\texttt{=>}}
\renewcommand{\pi}{\texttt{pi}}
\newcommand{\cdash}{\texttt{:-}} % colon-dash
\newcommand{\tailcut}{\texttt{tail\_cut}\xspace}
\newcommand{\arr}{\rightsquigarrow}

\def\mutExclHeads{\texttt{mut\_excl\_heads}}
\def\locExcl{\texttt{loc\_excl}}
\def\mutExcl{\texttt{mut\_excl}}
\def\mutExclHO{\texttt{mut\_excl\_HO}}
\def\detCheck{\texttt{det\_check}}
\def\detCheckHO{\texttt{det\_check\_HO}}
\newcommand{\lam}{\ensuremath{\lambda}}

\def\mutExclCut{\texttt{mut\_excl\_cut}}
\def\detPrem{\texttt{det\_prem}}
\def\wellModed{\texttt{well\_moded}}
\newcommand{\ground}[1]{\texttt{ground }#1}
\newcommand{\bs}{\text{\textbackslash}}

% runCmd{goal[]}{alts[]}{subst}{alts_res}{subst_res}
\newcommand{\runCmd}[5]{\ensuremath{\run\ #1\ #2\ #3 \arr (#4, #5)}}
\newcommand{\callCmd}[3]{\ensuremath{(\call\ #1\ #2\ #3)}\xspace}
\newcommand{\goalCmd}[3]{\ensuremath{\goal\ #1\ #2\ #3}\xspace}
\newcommand{\clauseCmd}[3]{\ensuremath{#1\ #2\ \cdash\ #3}}
\newcommand{\implCmd}[2]{\ensuremath{#1\ \impl\ #2}}
\newcommand{\piCmd}[2]{\ensuremath{\pi\ #1\bs\ #2}}
\newcommand{\lamCmd}[2]{\ensuremath{\lambda#1. #2}}

\newcommand{\piImplCmd}[3]{\piCmd{#1}{\implCmd{#2}{#3}}}

\newcommand{\unifyCmd}[4]{\ensuremath{\unify\ #1\ #2\ #3 \arr #4}}
\newcommand{\matchCmd}[4]{\ensuremath{\match\ #1\ #2\ #3 \arr #4}}

\newcommand{\tailcutCmd}[2]{\ensuremath{\tailcut\ #1\ #2}\xspace}

\newcommand{\Cons}[1]{\ensuremath{#1::}}
\newcommand{\ConsHd}[1]{\ensuremath{(#1::}\xspace}
\newcommand{\ConsTl}[1]{\ensuremath{#1)}\xspace}
\newcommand{\EmptyList}{\ensuremath{\varnothing}}

\newcommand{\EmptySubst}{\ensuremath{\varepsilon}}

\newcommand{\prog}[1][]{\ensuremath{\mathcal{P}#1}\xspace}
\newcommand{\evdash}{\ensuremath{\colondash}\xspace}
\newcommand{\piimpl}{{\ensuremath{\forall\Rightarrow}}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Derivation system: start
\newenvironment{myRule}[1]{%
   \begin{minipage}{#1\textwidth}
   \centering
   \begin{prooftree}%
  } % Here will be put the body
  {
    \end{prooftree}
    \vspace{2pt}
    \end{minipage}
  }

\newcommand{\ruleName}[2]{\customlabel{#1}{\ensuremath{r_{#2}}}}
\newcommand{\RightLabelM}[1]{\RightLabel{\scriptsize #1}}

\newcommand{\ruleFail}{\ruleName{rule:fail}{\bot}}
\newcommand{\ruleCall}{\ruleName{rule:call}{c}}
\newcommand{\ruleCallB}{\ruleName{rule:call1}{c'}}
\newcommand{\ruleBang}{\ruleName{rule:cut}{!}}
\newcommand{\ruleStop}{\ruleName{rule:stop}{\EmptyList}}
\newcommand{\ruleUnif}{\ruleName{rule:unif}{=}}
\newcommand{\ruleImpl}{\ruleName{rule:impl}{\Rightarrow}}
\newcommand{\rulePi}{\ruleName{rule:pi}{\forall}}
\newcommand{\ruleMatch}{\ruleName{rule:match}{m}}
\newcommand{\rulePiImpl}{\ruleName{rule:piimpl}{{\piimpl}}}

\newcommand{\ruleStopM}[1]{
  \begin{myRule}{#1}
    % STOP
    \AxiomC{}
    \RightLabelM{\ruleStop}
    \UnaryInfC{\runCmd{\EmptyList}{\alt}{\subst}{\alt}{\subst}}
  \end{myRule}
}

\newcommand{\ruleUnifM}[1]{
  \begin{myRule}{#1}
    % UNIF
    \AxiomC{\unifyCmd{x}{y}{\subst}{\subst[']}}
    \AxiomC{\runCmd{\g}{\alt}{\subst[']}{\alt[']}{\subst['']}}
    \RightLabelM{\ruleUnif}
    \BinaryInfC{\runCmd{\ConsHd{\goalCmd{\_}{(x = y)}{\_}}\ConsTl{\g}}{\alt}{\subst}{\alt[']}{\subst['']}}
  \end{myRule}
}

\newcommand{\ruleMatchM}[1]{
  \begin{myRule}{#1}
    % UNIF
    \AxiomC{\matchCmd{x}{y}{\subst}{\subst[']}}
    \AxiomC{\runCmd{\g}{\alt}{\subst[']}{\alt[']}{\subst['']}}
    \RightLabelM{\ruleMatch}
    \BinaryInfC{\runCmd{\ConsHd{\goalCmd{\_}{(x =_m y)}{\_}}\ConsTl{\g}}{\alt}{\subst}{\alt[']}{\subst['']}}
  \end{myRule}
}

\newcommand{\ruleFailM}[1]{
  \begin{myRule}{#1}
    % FAIL
    \AxiomC{\texttt{fail} \subst g}
    \AxiomC{\runCmd{a}{\alt}{\subst[']}{\alt[']}{\subst['']}}
    \RightLabelM{\ruleFail}
    \BinaryInfC{\runCmd{\ConsHd{g}\ConsTl{\_}}{\ConsHd{\subst['],a}\ConsTl{\alt}}{\subst}{\alt[']}{\subst['']}}
  \end{myRule}%
}

\newcommand{\ruleBangM}[1]{
  \begin{myRule}{#1}
    % CUT
    \AxiomC{\runCmd{\g}{\alt}{\subst}{\alt[']}{\subst[']}}
    \RightLabelM{\ruleBang}
    \UnaryInfC{\runCmd{\ConsHd{\goalCmd{\_}{\cut}{\alt}}\ConsTl{\g}}{\_}{\subst}{\alt[']}{\subst[']}}
  \end{myRule}
}

\newcommand{\ruleCallM}[1]{
  \begin{myRule}{#1}
    % CALL
    \AxiomC{$\mathcal{F}(\prog, \pred, i, o, \subst, \alt) = \ConsHd{(\_,g)}\ConsTl{new\_alt}$}
    \AxiomC{\runCmd{(g\ @\ \g)}{(new\_alt\ @\ \alt)}{\subst}{\alt[']}{\subst[']}}
    \RightLabelM{\ruleCall}
    \BinaryInfC{\runCmd{\ConsHd{\goalCmd{\prog}{\callCmd{\pred}{i}{o}}{\_}}\ConsTl{\g}}{\alt}{\subst}{\alt[']}{\subst[']}}
  \end{myRule}
}

\newcommand{\ruleCallBM}[1]{
  \begin{myRule}{#1}
    % CALLB
    \AxiomC{$(\subst h)\ t_1\ t_2 = \pred\ i\ o$}
    \AxiomC{$\mathcal{F}(\prog, \pred, i, o, \subst, \alt) = \ConsHd{(\_,g)}\ConsTl{new\_alt}$}
    \AxiomC{\runCmd{(g\ @\ \g)}{(new\_alt\ @\ \alt)}{\subst}{\alt[']}{\subst[']}}
    \RightLabelM{\ruleCallB}
    \TrinaryInfC{\runCmd{\ConsHd{\goalCmd{\prog}{(h\ t_1\ t_2)}{\_}}\ConsTl{\g}}{\alt}{\subst}{\alt[']}{\subst[']}}
  \end{myRule}
}

\newcommand{\ctx}[1][]{\ensuremath{\Gamma#1}}
\newcommand{\env}{\ensuremath{\mathcal{E}}}

% \newcommand{\ruleImplM}[1]{
%   \begin{myRule}{#1}
%     % IMPL
%     \AxiomC{\runCmd{\ConsHd{(\goalCmd{(H + \ctx)}{B}{\alt})}\ConsTl{\g}}{\alt[']}{\subst}{\alt['']}{\subst[']}}
%     \RightLabelM{\ruleImpl}
%     \UnaryInfC{\runCmd{\ConsHd{\goalCmd{\ctx}{(\implCmd{H}{B})}{\alt}}\ConsTl{\g}}{\alt[']}{\subst}{\alt['']}{\subst[']}}
%   \end{myRule}
% }

% \newcommand{\rulePiM}[1]{
%   \begin{myRule}{#1}
%     % PI
%     \AxiomC{\runCmd{\ConsHd{\goalCmd{(x \uplus \ctx)}{B}{\alt}}\ConsTl{\g}}{\alt[']}{\subst}{\alt['']}{\subst[']}}
%     \RightLabelM{\rulePi}
%     \UnaryInfC{\runCmd{\ConsHd{\goalCmd{\ctx}{(\piCmd{x}{B})}{\alt}}\ConsTl{\g}}{\alt[']}{\subst}{\alt['']}{\subst[']}}
%   \end{myRule}
% }

\newcommand{\rulePiImplM}[1]{
  \begin{myRule}{#1}
    % IMPL
    \AxiomC{\runCmd{\ConsHd{(\goalCmd{(x \uplus \env, H + \prog)}{B}{\alt})}\ConsTl{\g}}{\alt[']}{\subst}{\alt['']}{\subst[']}}
    \RightLabelM{\rulePiImpl}
    \UnaryInfC{\runCmd{\ConsHd{\goalCmd{\env,\prog}{(\piCmd{x}{\implCmd{H}{B}})}{\alt}}\ConsTl{\g}}{\alt[']}{\subst}{\alt['']}{\subst[']}}
  \end{myRule}
}

% \newcommand{\ruleLam}{\ruleName{\lambda}}
% \newcommand{\ruleLamM}[1]{
%   \begin{myRule}{#1}
%     % PI
%     \AxiomC{\runCmd{\ConsHd{\goalCmd{\ctx}{(B[x\backslash T])}{\alt}}\ConsTl{\g}}{\alt[']}{\subst}{\alt['']}{\subst[']}}
%     \RightLabelM{\ruleLam}
%     \UnaryInfC{\runCmd{\ConsHd{\goalCmd{\ctx}{((\lambda x. B) T)}{\alt}}\ConsTl{\g}}{\alt[']}{\subst}{\alt['']}{\subst[']}}
%   \end{myRule}
% }

% Derivation system: end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Static check rule system: start
\newcommand{\detT}[1]{\texttt{#1}}
\newcommand{\maxT}{\texttt{max}}
\newcommand{\minT}{\texttt{min}}
\newcommand{\detI}{\detT{fun}}
\newcommand{\isdet}{\detT{is\_det}}
\newcommand{\relI}{\detT{rel}}
\newcommand{\expI}{\detT{exp}}
\newcommand{\funsep}{\ensuremath{\triangleright}}
\newcommand{\myTo}{\ensuremath{\mathbin{\detT{->}}}}
\newcommand{\mySub}{\ensuremath{\subseteq}}
\newcommand{\detlab}{\texttt{detlab}}
\newcommand{\toF}{\texttt{toF}}
\newcommand{\U}{\mathcal{U}}
\newcommand{\UCmd}[3]{\U(#1, #2, #3)}

\newcommand{\func}[1][]{\ensuremath{\mathcal{F}#1}}
\newcommand{\get}[1]{\ensuremath{\texttt{get}_\texttt{#1}}}
\newcommand{\getI}[1]{\ensuremath{\get{i}\ #1}}
\newcommand{\getO}[1]{\ensuremath{\get{o}\ #1}}
\newcommand{\getF}[1]{\ensuremath{\get{F}\ #1}}
\newcommand{\infer}{\texttt{infer}}
\newcommand{\checkk}{\texttt{check}}
\newcommand{\checkc}{\texttt{check\_clause}}

\newcommand{\inferCmd}[2]{\ensuremath{\infer\ #1\ #2}}
\newcommand{\subCmd}[2]{\ensuremath{#1 \mySub #2}}
\newcommand{\notSubCmd}[2]{\ensuremath{#1 \not\mySub #2}}

% [checkCmd ctx1 func1 tm ctx2 func2]
\newcommand{\checkCmd}[5]{\ensuremath{(#1, #2) \vdash \checkk\ #3 \arr (#4, #5)}}
\newcommand{\checkClause}[2]{\ensuremath{#1 \vdash \checkc\ #2}}

% \newcommand{\ruleCheckName}[1]{\ensuremath{C_{#1}}\xspace}
\newcommand{\ruleCheckName}[2]{\customlabel{#1}{\ensuremath{C_{#2}}}}

\newcommand{\ruleCheckClause}{\ruleCheckName{rule:check-clause}{\cdash}}
\newcommand{\ruleCheckClauseM}[1]{
  \begin{myRule}{#1}
    % Clause
    \AxiomC{\subCmd{\inferCmd{\ctx}{i}}{\getI{\pred}}}
    \AxiomC{\checkCmd{\ctx}{\detI}{B}{\ctx[']}{\func[']}}
    \AxiomC{\subCmd{\inferCmd{\ctx}{o}}{\getO{\pred}}}
    \AxiomC{\subCmd{\func[']}{\getF{\pred}}}
    \RightLabelM{\ruleCheckClause}
    \QuaternaryInfC{\checkClause{\ctx}{(\clauseCmd{\pred}{i\ o}{B})}}
  \end{myRule}
}

\newcommand{\ruleCheckCut}{\ruleCheckName{rule:check-cut}{!}}
\newcommand{\ruleCheckCutM}[1]{
  \begin{myRule}{#1}
    % CUT
    \AxiomC{\checkCmd{\ctx}{\detI}{L}{\ctx[']}{\func[']}}
    \RightLabelM{\ruleCheckCut}
    \UnaryInfC{\checkCmd{\ctx}{\_}{\ConsHd{\cut}\ConsTl{L}}{\ctx[']}{\func[']}}
  \end{myRule}
}

\newcommand{\ruleCheckUnif}{\ruleCheckName{rule:check-unif}{=}}
\newcommand{\ruleCheckUnifM}[1]{
  \begin{myRule}{#1}
    % UNIF
    \AxiomC{\checkCmd{\ctx + \{A \mapsto \ctx\ B; B \mapsto \minT\ A\ B\}}{\func}{L}{\ctx[']}{\func[']}}
    \RightLabelM{\ruleCheckUnif}
    \UnaryInfC{\checkCmd{\ctx}{\func}{\ConsHd{A = B}\ConsTl{L}}{\ctx[']}{\func[']}}
  \end{myRule}
}

% \newcommand{\ruleCheckMatch}{\ruleCheckName{m}}
% \newcommand{\ruleCheckMatchM}[1]{
%   \begin{myRule}{#1}
%     % MATCH
%     \AxiomC{\checkCmd{\ctx + \{A \mapsto B; B \mapsto \min A\ B\}}{\func}{L}{\ctx[']}{\func[']}}
%     \RightLabelM{\ruleCheckMatch}
%     \UnaryInfC{\checkCmd{\ctx}{\func}{\ConsHd{A = B}\ConsTl{L}}{\ctx[']}{\func[']}}
%   \end{myRule}
% }

% \newcommand{\ruleCheckImpl}{\ruleCheckName{\Rightarrow}}
% \newcommand{\ruleCheckImplM}[1]{
%   \begin{myRule}{#1}
%     % IMPL
%     % \AxiomC{\checkClause{\ctx}{H}}
%     \AxiomC{\checkCmd{\ctx}{\func}{\ConsHd{B}\ConsTl{L}}{\ctx[']}{\func[']}}
%     \RightLabelM{\ruleCheckImpl}
%     \UnaryInfC{\checkCmd{\ctx}{\func}{\ConsHd{\implCmd{H}{B}}\ConsTl{L}}{\ctx[']}{\func[']}}
%   \end{myRule}
% }

% \newcommand{\ruleCheckPi}{\ruleCheckName{\forall}}
% \newcommand{\ruleCheckPiM}[1]{
%   \begin{myRule}{#1}
%     % PI
%     \AxiomC{\checkCmd{\ctx + \{x \mapsto \toF\ x\}}{\func}{\ConsHd{B}\ConsTl{L}}{\ctx[']}{\func[']}}
%     \RightLabelM{\ruleCheckPi}
%     \UnaryInfC{\checkCmd{\ctx}{\func}{\ConsHd{\piCmd{x}{B}}\ConsTl{L}}{\ctx[']}{\func[']}}
%   \end{myRule}
% }

\newcommand{\ruleCheckPiImpl}{\ruleCheckName{rule:check-ho}{\piimpl}}
\newcommand{\ruleCheckPiImplM}[1]{
  \begin{myRule}{#1}
    % PiImpl
    \AxiomC{\checkClause{\ctx}{H}}
    \AxiomC{\checkCmd{\ctx + \{x \mapsto \toF\ x\}}{\func}{\ConsHd{B}\ConsTl{L}}{\ctx[']}{\func[']}}
    \RightLabelM{\ruleCheckPiImpl}
    \BinaryInfC{\checkCmd{\ctx}{\func}{\ConsHd{\piImplCmd{x}{H}{B}}\ConsTl{L}}{\ctx[']}{\func[']}}
  \end{myRule}
}

\newcommand{\predVar}{\texttt{v}}

\newcommand{\ruleCheckCall}{\ruleCheckName{rule:check-callOK}{c}}
\newcommand{\ruleCheckCallM}[1]{
  \begin{myRule}{#1}
    % CALL SUCC
    \AxiomC{\subCmd{\inferCmd{\ctx}{i}}{\getI{\predVar}}}
    \AxiomC{\checkCmd{\ctx + \UCmd{\ctx}{\predVar}{o}}{\maxT\ \func\ (\getF{\predVar})}{L}{\ctx[']}{\func[']}}
    \RightLabelM{\ruleCheckCall}
    \BinaryInfC{\checkCmd{\ctx}{\func}{\ConsHd{\predVar\ i\ o}\ConsTl{L}}{\ctx[']}{\func[']}}
  \end{myRule}
}

\newcommand{\ruleCheckCallFail}{\ruleCheckName{rule:check-callKO}{\bot}}
\newcommand{\ruleCheckCallFailM}[1]{
  \begin{myRule}{#1}
    % CALL FAIL
    \AxiomC{\notSubCmd{\inferCmd{\ctx}{i}}{\getI{\predVar}}}
    \AxiomC{\checkCmd{\ctx + \UCmd{\ctx}{\bot}{o}}{\relI}{L}{\ctx[']}{\func[']}}
    \RightLabelM{\ruleCheckCallFail}
    \BinaryInfC{\checkCmd{\ctx}{\_}{\ConsHd{\predVar\ i\ o}\ConsTl{L}}{\ctx[']}{\func[']}}
  \end{myRule}
}


\newcommand{\ruleCheckEmpty}{\ruleCheckName{rule:check-stop}{\EmptyList}}
\newcommand{\ruleCheckEmptyM}[1]{
  \begin{myRule}{#1}
    % EMPTY
    \AxiomC{}
    \RightLabelM{\ruleCheckEmpty}
    \UnaryInfC{\checkCmd{\ctx}{\func}{\EmptyList}{\ctx}{\func}}
  \end{myRule}
}

% Static check rule system: end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\makeatletter
\def\thm@space@setup{\thm@preskip=0pt
  \thm@postskip=0pt}
\makeatother